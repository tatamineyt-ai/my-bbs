<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // あなたの最新の画像から取得した設定
    const firebaseConfig = {
        apiKey: "AIzaSyDxO3q-y_HAkt5t2LCjeJAVqK3pmjhujtc",
        authDomain: "my-bbs-app-77242.firebaseapp.com",
        projectId: "my-bbs-app-77242",
        storageBucket: "my-bbs-app-77242.firebasestorage.app", // ここが画像と一致するように修正
        messagingSenderId: "1057990079628",
        appId: "1:1057990079628:web:e2329a59ea98a14bf7a9",
        measurementId: "G-BDKNSLPSLE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // --- 以下、ログイン・投稿・削除の処理は前のコードと同じ ---
    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('login-ui').classList.add('hidden');
            document.getElementById('user-ui').classList.remove('hidden');
            document.getElementById('post-area').classList.remove('hidden');
            document.getElementById('display-name').innerText = user.displayName;
        } else {
            currentUser = null;
            document.getElementById('login-ui').classList.remove('hidden');
            document.getElementById('user-ui').classList.add('hidden');
            document.getElementById('post-area').classList.add('hidden');
        }
    });

    window.login = () => {
        signInWithPopup(auth, provider).catch(err => {
            alert("エラー: " + err.message);
            console.error(err);
        });
    };
    window.logout = () => signOut(auth);

    window.addPost = async () => {
        const msg = document.getElementById('message').value;
        if (!msg) return;
        await addDoc(collection(db, "posts"), {
            name: currentUser.displayName,
            text: msg,
            uid: currentUser.uid,
            timestamp: serverTimestamp()
        });
        document.getElementById('message').value = "";
    };

    window.deletePost = async (postId, postUid) => {
        if (currentUser && currentUser.uid === postUid) {
            if(confirm("削除しますか？")) await deleteDoc(doc(db, "posts", postId));
        } else {
            alert("自分の投稿しか消せません！");
        }
    };

    const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
        const postList = document.getElementById('post-list');
        postList.innerHTML = "";
        snapshot.forEach((doc) => {
            const data = doc.data();
            const time = data.timestamp ? data.timestamp.toDate().toLocaleString('ja-JP') : "...";
            const isMyPost = currentUser && currentUser.uid === data.uid;
            
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            postDiv.innerHTML = `
                <div class="post-header">
                    <strong>${data.name}</strong>
                    <span style="font-size:12px; color:gray">${time}</span>
                    ${isMyPost ? `<button class="delete-btn" onclick="deletePost('${doc.id}', '${data.uid}')">削除</button>` : ""}
                </div>
                <div style="margin-top:10px">${data.text}</div>
            `;
            postList.appendChild(postDiv);
        });
    });
</script>